## 10.1 AWS 上的自动配置

### 问题

您需要在 Amazon Web Services 上自动配置 NGINX服务器，以使机器能够自动进行自我配置。

### 解决方案

利用 EC2 `UserData` 以及预置的 Amazon Machine Image。使用 NGINX 和已安装的所有支持软件包创建 Amazon Machine Image（AMI）。利用 Amazon EC2 `UserData` 在运行时配置任何特定于环境的配置。

### 讨论

配置 Amazon Web Services 有三种模式：

*启动时配置*

从一个通用 Linux 映像启动，然后在启动时运行配置管理器或者 shell 脚本配置服务器。此模式会拉慢启动速度，并可能引发潜在错误。

*完全预置 AMIs*

完整配置服务器，然后打包成 AMI 使用。此模式启动迅速并且准确。不过，它削弱了对环境的适应性，同时，维护多个映像也是很复杂的。

*部分预置 AMIs*

混合前两种方案。必需软件预先安装并被打包进入 AMI，而环境配置在启动时完成。此模式相对于完整预置 AMI 更加灵活，相对于启动时配置方案启动更快。

无论你选择完整或者部分预置方案，你可能都希望该过程能够自动完成。为了指示 AMI 构建管线，建议使用下面两种工具：

*配置管理*

配置管理工具通过代码定义服务器的状态，例如要运行哪个版本的 NGINX，要以什么用户身份运行，要使用的 DNS 解析器以及向谁代理上游服务器。可以像软件项目一样对该配置管理代码进行源代码控制和版本控制。一些流行的配置管理工具是 Ansible，Chef，Puppet 和 SaltStack，在第5章中进行了介绍。

*来自 HashiCorp 的 Packer*

Packer 可用于在几乎任何虚拟化或云平台上自动运行配置管理，并在运行成功时刻录机器映像。Packer 基本上可以在您选择的平台上构建虚拟机，通过 SSH 进入虚拟机，运行您指定的任何配置，然后刻录映像。您可以使用 Packer 运行配置管理工具，并可靠地将机器映像刻录为您的规格。

要在启动时配置环境配置，您可以在首次启动实例时利用 Amazon EC2 `UserData` 运行命令。如果您使用的是部分预置的方法，则可以在启动时利用此方法配置基于环境的项目。基于环境的配置示例可能是要侦听的服务器名称，要使用的解析器，要代理的域名或开始时使用的上游服务器池。`UserData` 是 base64 编码的字符串，该字符串在首次引导时下载并运行。`UserData` 可以像 AMI 中其他引导程序访问的环境文件一样简单，也可以是用 AMI 上存在的任何语言编写的脚本。`UserData` 通常是一个 bash 脚本，用于指定变量或下载变量以传递给配置管理。配置管理可确保正确配置系统，基于环境变量对配置文件进行模板化以及重新加载服务。`UserData` 运行后，应以非常可靠的方式对 NGINX 计算机进行完整配置。

